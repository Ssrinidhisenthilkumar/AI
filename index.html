<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #8EC5FC;
            background-image: url("data:image/svg+xml,%3Csvg width='120' height='120' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill-opacity='0.3' fill='%23ffffff'%3E%3Cpath transform='translate(10 10) rotate(15 16 16)' d='M15.5 2.5l-13 13L0 30l1.5 1.5 14.5-2.5 13-13L15.5 2.5zm-1 1l11.5 11.5-12 12-11.5-11.5 12-12z'/%3E%3Cpath transform='translate(70 80) rotate(-10 12 12)' d='M12 0l12 21H0z'/%3E%3Cpath transform='translate(80 15) rotate(25 10 10)' d='M18 3h-3a2 2 0 00-2 2v10a4 4 0 01-4 4H5a2 2 0 00-2 2v0a2 2 0 002 2h4a6 6 0 006-6V5a4 4 0 014-4h1a2 2 0 002-2v0a2 2 0 00-2-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"), linear-gradient(120deg, #E0C3FC 0%, #8EC5FC 100%);
            animation: moveShapes 20s linear infinite;
        }

        @keyframes moveShapes {
            from { background-position: 0 0; }
            to { background-position: 120px 120px; }
        }

        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .chat-bubble-ai {
            background-color: #ffffff; /* white */
            color: #1F2937; /* gray-800 */
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .correct-answer {
            background-color: #10B981 !important; /* Emerald-500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .wrong-answer {
            background-color: #EF4444 !important; /* Red-500 */
            color: white !important;
            border-color: #DC2626 !important;
        }
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #A8A29E;
            color: #A8A29E;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #A8A29E;
            color: #A8A29E;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #A8A29E;
            color: #A8A29E;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: #A8A29E; } /* gray-400 */
            50%, 100% { background-color: #44403C; } /* gray-700 */
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <div class="w-full max-w-lg mx-auto bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl flex flex-col h-[90vh]">
        <!-- Header -->
        <div class="p-4 border-b border-gray-200/80 rounded-t-2xl bg-gray-50/80">
            <h1 class="text-xl font-bold text-gray-800 text-center">AI Tutor</h1>
            <p class="text-sm text-gray-500 text-center">Ask me a math problem!</p>
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Initial AI Welcome Message -->
            <div class="flex justify-start">
                <div class="chat-bubble-ai p-3 rounded-lg max-w-xs lg:max-w-md">
                    <p class="text-sm">Hello! Ask me a math problem, and I'll help you learn how to solve it.</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200/80 bg-gray-50/80 rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <input type="text" id="user-input" placeholder="Type your message..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white/70">
                <button id="send-btn" class="bg-blue-500 text-white rounded-full p-3 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                    <!-- Changed to a send icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // --- State Management ---
        let currentProblemState = null;

        // --- Gemini API Configuration ---
        // IMPORTANT: For Vercel deployment, you MUST set your API key as an Environment Variable.
        // This code assumes you have an environment variable named `VITE_GEMINI_API_KEY` or similar,
        // which you would then expose to your frontend code securely.
        // For this example, we'll leave it blank, as the environment should provide it.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const systemPrompt = `You are an AI Math Tutor. Your goal is to help users learn.
            When a user asks a math problem:
            1. Provide a step-by-step explanation of the method.
            2. Provide four multiple-choice options (one correct, three plausible distractors).
            3. Provide an array of 2-3 short, helpful hints that re-explain the concept in a different way.
            4. You MUST format your response as a single, minified JSON object with NO markdown. The JSON must have these keys: "isMathProblem" (boolean, true), "explanation" (string with HTML), "options" (array of 4 numbers), "correctAnswer" (number), and "hints" (array of strings).
            Example for '5 + 3': {"isMathProblem":true,"explanation":"Start at <strong>5</strong> and count up 3 more.","options":[7,8,9,6],"correctAnswer":8, "hints":["Think of a number line.", "What comes after 5, 6, 7...?"]}
            
            If the query is NOT a math problem, respond as a helpful assistant. The JSON must have "isMathProblem" set to false and "responseText" with the answer.
            Example for 'Capital of France?': {"isMathProblem":false,"responseText":"The capital of France is <strong>Paris</strong>."}`;

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleUserInput);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !userInput.disabled) handleUserInput();
        });

        function handleUserInput() {
            const query = userInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            userInput.value = '';
            
            // Disable input while fetching response
            userInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50', 'cursor-not-allowed');

            getAiResponse(query);
        }

        function enableInput() {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            userInput.focus();
        }

        async function getAiResponse(query) {
            const loadingBubbleId = `loading-${Date.now()}`;
            addMessage('<div class="dot-flashing"></div>', 'ai', loadingBubbleId);

            const maxRetries = 3;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Retry on server errors or rate limiting
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    // Don't retry on client errors (like bad API key)
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("Non-retriable API error:", response.status, errorBody);
                        updateMessage(loadingBubbleId, "There was an issue with the request. Please check the API key or input.");
                        enableInput();
                        return;
                    }

                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiText) {
                        processAiResponse(aiText, loadingBubbleId);
                    } else {
                        updateMessage(loadingBubbleId, "I'm sorry, I couldn't generate a response.");
                    }
                    enableInput();
                    return; // Success, exit the loop

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        updateMessage(loadingBubbleId, "Oops! Something went wrong after multiple attempts.");
                        enableInput();
                    } else {
                        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }
        }

        function processAiResponse(text, loadingId) {
            try {
                const data = JSON.parse(text);
                if (data.isMathProblem) {
                    currentProblemState = {
                        ...data,
                        attempts: 0,
                        container: null // Will hold the options container element
                    };
                    updateMessage(loadingId, data.explanation);
                    displayOptions();
                } else {
                    currentProblemState = null; // Reset for non-math questions
                    updateMessage(loadingId, data.responseText);
                }
            } catch (error) {
                console.error("Failed to parse AI response JSON:", error);
                currentProblemState = null;
                // Fallback for plain text or malformed JSON
                updateMessage(loadingId, text); 
            }
        }

        function displayOptions() {
            const { options } = currentProblemState;
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'flex justify-start';
            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'grid grid-cols-2 gap-2 mt-2';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'option-btn bg-white border border-gray-300 text-gray-700 rounded-lg p-2 hover:bg-gray-100';
                button.onclick = (event) => checkAnswer(option, event.target);
                optionsGrid.appendChild(button);
            });

            optionsContainer.appendChild(optionsGrid);
            chatBox.appendChild(optionsContainer);
            currentProblemState.container = optionsContainer; // Store reference
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function checkAnswer(selectedOption, buttonElement) {
            if (!currentProblemState) return;
            
            const { correctAnswer, hints } = currentProblemState;
            currentProblemState.attempts++;

            if (selectedOption === correctAnswer) {
                // Correct Answer Logic
                buttonElement.classList.add('correct-answer');
                disableAllOptions();
                setTimeout(() => addMessage("That's correct! Great job!", 'ai'), 300);
            } else {
                // Incorrect Answer Logic
                buttonElement.disabled = true;
                buttonElement.classList.add('wrong-answer');
                
                if (currentProblemState.attempts < 3) { // Allow 2 hints
                    // Provide a hint
                    const hint = hints[currentProblemState.attempts - 1] || "Let's try thinking about it another way.";
                    setTimeout(() => addMessage(`Not quite. Here's a hint: <strong>${hint}</strong>`, 'ai'), 300);
                } else {
                    // Third wrong attempt, reveal answer
                    disableAllOptions(true); // Reveal correct answer
                    setTimeout(() => addMessage(`It looks like this one was tricky. The correct answer was <strong>${correctAnswer}</strong>.`, 'ai'), 300);
                }
            }
        }
        
        function disableAllOptions(revealAnswer = false) {
            if (!currentProblemState || !currentProblemState.container) return;
            const { container, correctAnswer } = currentProblemState;
            const buttons = container.querySelectorAll('.option-btn');
            buttons.forEach(button => {
                button.disabled = true;
                if (revealAnswer && parseInt(button.textContent) === correctAnswer) {
                    button.classList.add('correct-answer');
                }
            });
        }
        
        function updateMessage(id, newHtml) {
            const messageBubble = document.getElementById(id);
            if (messageBubble) {
                messageBubble.innerHTML = `<p class="text-sm">${newHtml}</p>`;
            }
        }

        function addMessage(text, sender, id = null) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            messageBubble.className = `p-3 rounded-lg max-w-xs lg:max-w-md ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            if (id) messageBubble.id = id;
            // Use innerHTML to correctly render HTML tags like <strong> from the AI response
            messageBubble.innerHTML = `<p class="text-sm">${text}</p>`;
            messageWrapper.appendChild(messageBubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

</body>
</html>
